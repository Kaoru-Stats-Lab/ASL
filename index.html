<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ASL v2.7.6 | Adult Stats Lab</title>
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-606GEFXTW4"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-606GEFXTW4');
    </script>
    <style>
        body { background-color: #000; color: #fff; font-family: 'Helvetica Neue', Arial, sans-serif; margin: 0; overflow-x: hidden; }
        .container { padding: 20px; max-width: 1000px; margin: 0 auto; }
        .shield { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 9999; display: flex; align-items: center; justify-content: center; transition: opacity 0.5s ease; }
        .shield.hidden { opacity: 0; pointer-events: none; }
        .shield-btn { background: #ff4757; color: white; border: none; padding: 15px 40px; border-radius: 50px; cursor: pointer; font-weight: bold; font-size: 1.1rem; box-shadow: 0 4px 15px rgba(255, 71, 87, 0.4); }
        .carousel { display: flex; overflow-x: auto; gap: 15px; padding-bottom: 20px; scroll-snap-type: x mandatory; -webkit-overflow-scrolling: touch; }
        .carousel img { height: 450px; border-radius: 12px; scroll-snap-align: start; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        .detail-card { background: #111; border: 1px solid #222; border-radius: 20px; padding: 30px; margin-top: 20px; }
        h1 { font-size: 1.8rem; line-height: 1.4; margin-top: 0; color: #fff; }
        .meta-info { color: #888; margin-bottom: 20px; font-size: 0.95rem; display: flex; gap: 20px; flex-wrap: wrap; }
        .tag { background: #222; padding: 4px 12px; border-radius: 4px; color: #ff4757; font-weight: bold; }
        .insight-box { border-left: 4px solid #ff4757; padding: 5px 20px; background: rgba(255, 71, 87, 0.05); margin: 25px 0; font-style: italic; color: #eee; font-size: 1.1rem; }
        .desc-text { color: #ccc; line-height: 1.8; font-size: 1rem; }
        .loading { text-align: center; padding: 50px; color: #555; font-size: 1.2rem; }
    </style>
</head>
<body>

<div id="shield" class="shield">
    <button class="shield-btn" onclick="unlock()">SHIELD ACTIVE (CLICK TO UNLOCK)</button>
</div>

<div class="container">
    <div id="main-content" class="loading">Loading data from spreadsheet...</div>
</div>

<script>
    const CONFIG = {
        // あなたが提供した最新のGAS URL
        API: 'https://script.google.com/macros/s/AKfycbwpjpE95dwEeMB3VSkBdGiP38PTLtdtU_FCJ1Eia8pTg3sDLX75C5vMvH67bCIAapi-TQ/exec'
    };

    function unlock() {
        document.getElementById('shield').classList.add('hidden');
        gtag('event', 'shield_unlock', { 'event_category': 'engagement' });
    }

    async function fetchData() {
        const path = window.location.pathname;
        const productId = path.includes('/p/') ? path.split('/').filter(Boolean).pop() : null;
        const contentArea = document.getElementById('main-content');

        try {
            // URLパラメータを正しく構築
            let url = CONFIG.API;
            if (productId) url += `?id=${productId}`;

            const response = await fetch(url);
            const data = await response.json();

            // 1件データ（詳細）か複数データ（リスト）か判定
            if (productId && !Array.isArray(data)) {
                renderDetail(data);
            } else {
                renderList(Array.isArray(data) ? data : [data]);
            }
        } catch (error) {
            contentArea.innerHTML = '<div style="color:#ff4757">Failed to load data. Please check GAS settings.</div>';
            console.error('Fetch Error:', error);
        }
    }

    function renderDetail(item) {
        if (item.error) {
            document.getElementById('main-content').innerHTML = 'Product not found.';
            return;
        }

        // 画像URLを分割してカルーセル作成
        const images = item.IMAGE_URLS ? item.IMAGE_URLS.split(',') : [];
        const carouselHtml = images.map(src => `<img src="${src.trim()}" loading="lazy">`).join('');

        document.getElementById('main-content').innerHTML = `
            <div class="carousel">${carouselHtml}</div>
            <div class="detail-card">
                <div class="meta-info">
                    <span>ID: <strong>${item.CID}</strong></span>
                    <span class="tag">${item.TIER || 'Standard'}</span>
                    <span>Actress: <strong>${item.ACTRESS_NAME}</strong></span>
                </div>
                <h1>${item.TITLE}</h1>
                <div class="insight-box">${item.INSIGHT_TEXT || 'No insight available.'}</div>
                <div class="desc-text">${item.META_DESC || ''}</div>
                <div style="margin-top:40px;">
                    <a href="/" style="color:#888; text-decoration:none;">← Back to Home</a>
                </div>
            </div>
        `;
        document.title = `${item.TITLE} | ASL v2.7.6`;
    }

    function renderList(list) {
        const cards = list.map(item => `
            <div class="detail-card" style="cursor:pointer; margin-bottom:20px;" onclick="location.href='/p/${item.CID}'">
                <div style="display:flex; gap:20px;">
                    <img src="${item.IMAGE_URLS.split(',')[0]}" style="width:120px; height:160px; object-fit:cover; border-radius:8px;">
                    <div>
                        <h3 style="margin:0 0 10px 0;">${item.TITLE}</h3>
                        <p style="color:#888;">${item.ACTRESS_NAME}</p>
                    </div>
                </div>
            </div>
        `).join('');
        document.getElementById('main-content').innerHTML = cards;
    }

    // 起動
    fetchData();
</script>

</body>
</html>
